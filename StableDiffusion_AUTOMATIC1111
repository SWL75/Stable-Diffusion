{"cells":[{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"lHzMJ9F3O2jD","outputId":"25d63d4d-f71a-488d-c41e-740c5637a202"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n","Found existing installation: torch 2.3.1+cu121\n","Uninstalling torch-2.3.1+cu121:\n","  Successfully uninstalled torch-2.3.1+cu121\n","Found existing installation: torchaudio 2.3.1+cu121\n","Uninstalling torchaudio-2.3.1+cu121:\n","  Successfully uninstalled torchaudio-2.3.1+cu121\n","Found existing installation: torchvision 0.18.1+cu121\n","Uninstalling torchvision-0.18.1+cu121:\n","  Successfully uninstalled torchvision-0.18.1+cu121\n","Found existing installation: torchtext 0.18.0\n","Uninstalling torchtext-0.18.0:\n","  Successfully uninstalled torchtext-0.18.0\n","Collecting torch==2.2.2\n","  Downloading torch-2.2.2-cp310-cp310-manylinux1_x86_64.whl.metadata (26 kB)\n","Collecting torchvision==0.17.2\n","  Downloading torchvision-0.17.2-cp310-cp310-manylinux1_x86_64.whl.metadata (6.6 kB)\n","Collecting torchaudio==2.2.2\n","  Downloading torchaudio-2.2.2-cp310-cp310-manylinux1_x86_64.whl.metadata (6.4 kB)\n","Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from torch==2.2.2) (3.15.4)\n","Requirement already satisfied: typing-extensions>=4.8.0 in /usr/local/lib/python3.10/dist-packages (from torch==2.2.2) (4.12.2)\n","Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch==2.2.2) (1.13.1)\n","Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch==2.2.2) (3.3)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch==2.2.2) (3.1.4)\n","Requirement already satisfied: fsspec in /usr/local/lib/python3.10/dist-packages (from torch==2.2.2) (2023.6.0)\n","Collecting nvidia-cuda-nvrtc-cu12==12.1.105 (from torch==2.2.2)\n","  Using cached nvidia_cuda_nvrtc_cu12-12.1.105-py3-none-manylinux1_x86_64.whl.metadata (1.5 kB)\n","Collecting nvidia-cuda-runtime-cu12==12.1.105 (from torch==2.2.2)\n","  Using cached nvidia_cuda_runtime_cu12-12.1.105-py3-none-manylinux1_x86_64.whl.metadata (1.5 kB)\n","Collecting nvidia-cuda-cupti-cu12==12.1.105 (from torch==2.2.2)\n","  Using cached nvidia_cuda_cupti_cu12-12.1.105-py3-none-manylinux1_x86_64.whl.metadata (1.6 kB)\n","Collecting nvidia-cudnn-cu12==8.9.2.26 (from torch==2.2.2)\n","  Using cached nvidia_cudnn_cu12-8.9.2.26-py3-none-manylinux1_x86_64.whl.metadata (1.6 kB)\n","Collecting nvidia-cublas-cu12==12.1.3.1 (from torch==2.2.2)\n","  Using cached nvidia_cublas_cu12-12.1.3.1-py3-none-manylinux1_x86_64.whl.metadata (1.5 kB)\n","Collecting nvidia-cufft-cu12==11.0.2.54 (from torch==2.2.2)\n","  Using cached nvidia_cufft_cu12-11.0.2.54-py3-none-manylinux1_x86_64.whl.metadata (1.5 kB)\n","Collecting nvidia-curand-cu12==10.3.2.106 (from torch==2.2.2)\n","  Using cached nvidia_curand_cu12-10.3.2.106-py3-none-manylinux1_x86_64.whl.metadata (1.5 kB)\n","Collecting nvidia-cusolver-cu12==11.4.5.107 (from torch==2.2.2)\n","  Using cached nvidia_cusolver_cu12-11.4.5.107-py3-none-manylinux1_x86_64.whl.metadata (1.6 kB)\n","Collecting nvidia-cusparse-cu12==12.1.0.106 (from torch==2.2.2)\n","  Using cached nvidia_cusparse_cu12-12.1.0.106-py3-none-manylinux1_x86_64.whl.metadata (1.6 kB)\n","Collecting nvidia-nccl-cu12==2.19.3 (from torch==2.2.2)\n","  Downloading nvidia_nccl_cu12-2.19.3-py3-none-manylinux1_x86_64.whl.metadata (1.8 kB)\n","Collecting nvidia-nvtx-cu12==12.1.105 (from torch==2.2.2)\n","  Using cached nvidia_nvtx_cu12-12.1.105-py3-none-manylinux1_x86_64.whl.metadata (1.7 kB)\n","Collecting triton==2.2.0 (from torch==2.2.2)\n","  Downloading triton-2.2.0-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (1.4 kB)\n","Requirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from torchvision==0.17.2) (1.25.2)\n","Requirement already satisfied: pillow!=8.3.*,>=5.3.0 in /usr/local/lib/python3.10/dist-packages (from torchvision==0.17.2) (9.4.0)\n","Collecting nvidia-nvjitlink-cu12 (from nvidia-cusolver-cu12==11.4.5.107->torch==2.2.2)\n","  Downloading nvidia_nvjitlink_cu12-12.5.82-py3-none-manylinux2014_x86_64.whl.metadata (1.5 kB)\n","Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2->torch==2.2.2) (2.1.5)\n","Requirement already satisfied: mpmath<1.4,>=1.1.0 in /usr/local/lib/python3.10/dist-packages (from sympy->torch==2.2.2) (1.3.0)\n","Downloading torch-2.2.2-cp310-cp310-manylinux1_x86_64.whl (755.5 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m755.5/755.5 MB\u001b[0m \u001b[31m2.0 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading torchvision-0.17.2-cp310-cp310-manylinux1_x86_64.whl (6.9 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m6.9/6.9 MB\u001b[0m \u001b[31m115.1 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading torchaudio-2.2.2-cp310-cp310-manylinux1_x86_64.whl (3.3 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m3.3/3.3 MB\u001b[0m \u001b[31m93.0 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hUsing cached nvidia_cublas_cu12-12.1.3.1-py3-none-manylinux1_x86_64.whl (410.6 MB)\n","Using cached nvidia_cuda_cupti_cu12-12.1.105-py3-none-manylinux1_x86_64.whl (14.1 MB)\n","Using cached nvidia_cuda_nvrtc_cu12-12.1.105-py3-none-manylinux1_x86_64.whl (23.7 MB)\n","Using cached nvidia_cuda_runtime_cu12-12.1.105-py3-none-manylinux1_x86_64.whl (823 kB)\n","Using cached nvidia_cudnn_cu12-8.9.2.26-py3-none-manylinux1_x86_64.whl (731.7 MB)\n","Using cached nvidia_cufft_cu12-11.0.2.54-py3-none-manylinux1_x86_64.whl (121.6 MB)\n","Using cached nvidia_curand_cu12-10.3.2.106-py3-none-manylinux1_x86_64.whl (56.5 MB)\n","Using cached nvidia_cusolver_cu12-11.4.5.107-py3-none-manylinux1_x86_64.whl (124.2 MB)\n","Using cached nvidia_cusparse_cu12-12.1.0.106-py3-none-manylinux1_x86_64.whl (196.0 MB)\n","Downloading nvidia_nccl_cu12-2.19.3-py3-none-manylinux1_x86_64.whl (166.0 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m166.0/166.0 MB\u001b[0m \u001b[31m3.8 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hUsing cached nvidia_nvtx_cu12-12.1.105-py3-none-manylinux1_x86_64.whl (99 kB)\n","Downloading triton-2.2.0-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (167.9 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m167.9/167.9 MB\u001b[0m \u001b[31m14.8 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading nvidia_nvjitlink_cu12-12.5.82-py3-none-manylinux2014_x86_64.whl (21.3 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m21.3/21.3 MB\u001b[0m \u001b[31m100.2 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hInstalling collected packages: triton, nvidia-nvtx-cu12, nvidia-nvjitlink-cu12, nvidia-nccl-cu12, nvidia-curand-cu12, nvidia-cufft-cu12, nvidia-cuda-runtime-cu12, nvidia-cuda-nvrtc-cu12, nvidia-cuda-cupti-cu12, nvidia-cublas-cu12, nvidia-cusparse-cu12, nvidia-cudnn-cu12, nvidia-cusolver-cu12, torch, torchvision, torchaudio\n","  Attempting uninstall: triton\n","    Found existing installation: triton 2.3.1\n","    Uninstalling triton-2.3.1:\n","      Successfully uninstalled triton-2.3.1\n"]}],"source":["import os\n","import shutil\n","from google.colab import drive\n","import subprocess\n","\n","drive.mount('/content/drive')\n","\n","!pip uninstall --yes torch torchaudio torchvision torchtext\n","!pip install torch==2.2.2 torchvision==0.17.2 torchaudio==2.2.2\n","!pip install xformers==0.0.25.post1 --index-url https://download.pytorch.org/whl/cu121\n","\n","%cd /content/\n","\n","!git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui\n","%cd /content/stable-diffusion-webui\n","githubUrls = {\n","    'extensions': [\n","        'https://github.com/butaixianran/Stable-Diffusion-Webui-Civitai-Helper',\n","        'https://github.com/AI-Creators-Society/stable-diffusion-webui-localization-ja_JP',\n","        'https://github.com/Mikubill/sd-webui-controlnet',\n","        'https://github.com/AlUlkesh/stable-diffusion-webui-images-browser',\n","        'https://github.com/Physton/sd-webui-prompt-all-in-one',\n","        'https://github.com/Bing-su/adetailer',\n","\n","\n","    ]\n","}\n","\n","folder_path = '/content/stable-diffusion-webui/'\n","\n","for category, urls in githubUrls.items():\n","    destination = folder_path+category\n","    for url in urls:\n","\n","        repo_name = url.split('/')[-1]\n","        clone_path = os.path.join(destination, repo_name)\n","        if not os.path.exists(clone_path):\n","            subprocess.call(['git', 'clone', url, clone_path])\n","        else:\n","            print(f'{repo_name}はすでにダウンロードされています。 再度ダウンロードする必要がある場合は該当ファイルを削除してください。\\n')\n","paths = {\n","    '/content/drive/MyDrive/StableDiffusion/CheckPoint': '/content/stable-diffusion-webui/models/Stable-diffusion',\n","    '/content/drive/MyDrive/StableDiffusion/Embeddings': '/content/stable-diffusion-webui/embeddings',\n","    '/content/drive/MyDrive/StableDiffusion/Lora': '/content/stable-diffusion-webui/models/Lora',\n","    '/content/drive/MyDrive/StableDiffusion/VAE': '/content/stable-diffusion-webui/models/VAE',\n","    '/content/drive/MyDrive/StableDiffusion/ControlNet': '/content/stable-diffusion-webui/models/ControlNet',\n","    '/content/drive/MyDrive/StableDiffusion/Config/config.json': '/content/stable-diffusion-webui/config.json',\n","    '/content/drive/MyDrive/StableDiffusion/Config/styles.csv':'/content/stable-diffusion-webui/styles.csv',\n","    '/content/drive/MyDrive/StableDiffusion/Config/Stable-Diffusion-Webui-Civitai-Helper/setting.json': '/content/stable-diffusion-webui/extensions/Stable-Diffusion-Webui-Civitai-Helper/setting.json',\n","    '/content/drive/MyDrive/StableDiffusion/Config/sd-webui-prompt-all-in-one/storage/':'/content/stable-diffusion-webui/extensions/sd-webui-prompt-all-in-one/storage',\n","}\n","\n","for path, link_path in paths.items():\n","    if not os.path.exists(path):\n","        print(f'リンク元のパスが存在しません: {path}')\n","        continue;\n","    if os.path.exists(link_path):\n","\n","        if os.path.islink(link_path):\n","            continue\n","        elif os.path.isfile(link_path):\n","            os.remove(link_path)\n","        else:\n","            shutil.rmtree(link_path)\n","\n","\n","    !ln -s $path $link_path\n","\n","!pip install insightface==0.7.3\n","!pip install gradio_client==0.2.7\n","\n","!pip install fonts\n","!pip install font-roboto"]},{"cell_type":"markdown","metadata":{"id":"ARRiF6u5Ei6A"},"source":["\n","WEB-UIの起動\n","↓の（▶）で WEB-UIの「起動」「停止」「再起動」を操作します。"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"QgBh9M38Ex0b"},"outputs":[],"source":["%cd /content/stable-diffusion-webui\n","!python launch.py --share --xformers --enable-insecure-extension-access"]},{"cell_type":"markdown","metadata":{"id":"KLzVHyJDf6zq"},"source":["生成したデータ「Outputデータ」をGoogleドライブへコピー"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"fIorwLcpUJqu"},"outputs":[],"source":["import os\n","\n","output_folder = \"/content/stable-diffusion-webui/output\"\n","fallback_folder = \"/content/stable-diffusion-webui/outputs\"\n","zip_file = \"/content/sd_output.zip\"\n","\n","if os.path.exists(output_folder):\n","    !zip -r {zip_file} {output_folder}\n","elif os.path.exists(fallback_folder):\n","    !zip -r {zip_file} {fallback_folder}\n","else:\n","    print(f\"Neither '{output_folder}' nor '{fallback_folder}' found.\")\n","\n","if os.path.exists(zip_file):\n","    from google.colab import files\n","    files.download(zip_file)"]}],"metadata":{"accelerator":"GPU","colab":{"gpuType":"T4","provenance":[],"machine_shape":"hm","authorship_tag":"ABX9TyP5YOTSdOH6SuTmW/KqOI0m"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}